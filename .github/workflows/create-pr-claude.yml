name: Auto-deploy Claude branches to main

on:
  push:
    branches:
      - 'claude/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create PR and merge to main
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "Branch: $BRANCH"

          # Check for existing open PR
          EXISTING=$(gh pr list --base main --head "$BRANCH" --state open --json number --jq '.[0].number // ""')

          if [ -z "$EXISTING" ]; then
            TITLE=$(echo "$BRANCH" | sed 's|claude/||' | tr '-' ' ')
            PR_URL=$(gh pr create \
              --base main \
              --head "$BRANCH" \
              --title "$TITLE" \
              --body "Automated deployment from Claude Code session. Branch: \`$BRANCH\`")
            echo "Created PR: $PR_URL"
            PR_NUM=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          else
            PR_NUM="$EXISTING"
            echo "Using existing PR #$PR_NUM"
          fi

          # Wait for mergeability
          for i in $(seq 1 8); do
            sleep 5
            MERGEABLE=$(gh pr view "$PR_NUM" --json mergeable --jq '.mergeable')
            echo "Attempt $i: mergeable=$MERGEABLE"
            if [ "$MERGEABLE" = "MERGEABLE" ]; then break; fi
            if [ "$MERGEABLE" = "CONFLICTING" ]; then echo "Has conflicts"; exit 1; fi
          done

          gh pr merge "$PR_NUM" --squash --delete-branch=false
          echo "Merged PR #$PR_NUM to main"
