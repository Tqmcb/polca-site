name: Auto-deploy Claude branches to main

on:
  push:
    branches:
      - 'claude/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Merge branch to main via API
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
        run: |
          set -e
          echo "Merging $BRANCH ($SHA) into main"

          RESP=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/$OWNER/$REPO/merges" \
            -d "{
              \"base\": \"main\",
              \"head\": \"$BRANCH\",
              \"commit_message\": \"Auto-merge $BRANCH into main\"
            }")

          BODY=$(echo "$RESP" | head -n -1)
          CODE=$(echo "$RESP" | tail -n 1)
          echo "HTTP $CODE"
          echo "$BODY" | python3 -c "import sys,json; d=json.load(sys.stdin); print('SHA:', d.get('sha',''), 'MSG:', d.get('message','ok'))"

          if [ "$CODE" = "201" ] || [ "$CODE" = "204" ]; then
            echo "Merge successful!"
          else
            echo "Merge failed with HTTP $CODE"
            echo "$BODY"
            exit 1
          fi
