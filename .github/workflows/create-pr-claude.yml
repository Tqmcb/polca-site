name: Auto-deploy Claude branches to main

on:
  push:
    branches:
      - 'claude/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Create PR via REST API and merge
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -e
          echo "Branch: $BRANCH"

          # Find existing open PR
          OPEN=$(curl -sf -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$OWNER/$REPO/pulls?state=open&base=main&head=$OWNER:$BRANCH" \
            | python3 -c "import sys,json; prs=json.load(sys.stdin); print(prs[0]['number'] if prs else '')" 2>/dev/null || true)

          if [ -z "$OPEN" ]; then
            TITLE=$(echo "$BRANCH" | sed 's|claude/||' | tr '-' ' ')
            RESP=$(curl -sf -X POST -H "Authorization: token $TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/$OWNER/$REPO/pulls" \
              -d "{\"title\":\"$TITLE\",\"head\":\"$BRANCH\",\"base\":\"main\",\"body\":\"Auto-deploy from Claude Code\"}" 2>&1)
            echo "Create PR response: $RESP"
            PR_NUM=$(echo "$RESP" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('number','ERROR: '+str(d.get('message','?'))))")
          else
            PR_NUM="$OPEN"
            echo "Using existing PR #$PR_NUM"
          fi

          echo "PR number: $PR_NUM"

          # Wait for mergeability
          for i in $(seq 1 10); do
            sleep 6
            MERGEABLE=$(curl -sf -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$OWNER/$REPO/pulls/$PR_NUM" \
              | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('mergeable','null'))")
            echo "Attempt $i: mergeable=$MERGEABLE"
            [ "$MERGEABLE" = "true" ] && break
            [ "$MERGEABLE" = "false" ] && echo "Conflicts!" && exit 1
          done

          # Merge
          MERGE=$(curl -sf -X PUT -H "Authorization: token $TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/$OWNER/$REPO/pulls/$PR_NUM/merge" \
            -d "{\"merge_method\":\"squash\"}" 2>&1)
          echo "Merge response: $MERGE"
          echo "Done."
